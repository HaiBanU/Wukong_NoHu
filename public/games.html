<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Game</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/user.css">
</head>
<body class="games-page">
    <video autoplay muted loop id="background-video">
        <source src="/assets/videos/space-bg.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>
    <div class="shooting-stars"><span class="star"></span><span class="star"></span></div>

    <header class="header games-header fadeIn">
        <a href="javascript:history.back()" class="back-button-user">← Quay Lại</a>
        <h2 id="lobby-title">Đang tải...</h2>
        <div id="live-clock-container"></div>
    </header>

    <main class="main-content fadeIn" style="animation-delay: 0.2s;">
        <!-- === THÊM MỚI: Ô TÌM KIẾM GAME === -->
        <div class="search-container">
            <input type="text" id="game-search-input" placeholder="Nhập tên game để tìm kiếm...">
        </div>
        
        <div class="grid-container" id="game-container">
            <!-- Game cards will be inserted here -->
        </div>
    </main>
    
    <div class="terminal-notification fadeIn" style="animation-delay: 0.5s;">
        <div class="terminal-bot-icon"><img src="/assets/images/bot-icon.png" alt="Bot Icon"></div>
        <div class="terminal-content">
            <div class="terminal-header">Terminal</div>
            <div class="terminal-body"><span id="terminal-message"></span><span class="cursor"></span></div>
        </div>
    </div>

    <script>
        function updateClock() { const clockContainer = document.getElementById('live-clock-container'); if (!clockContainer) return; const now = new Date(); const timeString = now.toLocaleTimeString('vi-VN'); const dateString = now.toLocaleDateString('vi-VN'); clockContainer.innerHTML = `<span class="clock-time">${timeString}</span><span class="clock-date">${dateString}</span>`; }
        const terminalMessages = [ "Đang quét các game...", "Phân tích dữ liệu thời gian thực.", "Chúc bạn may mắn!" ];
        let currentMessageIndex = 0; let typingInterval;
        function typeMessage(element, message) { if (typingInterval) clearInterval(typingInterval); let i = 0; element.innerHTML = ''; typingInterval = setInterval(() => { if (i < message.length) { element.textContent += message.charAt(i); i++; } else { clearInterval(typingInterval); } }, 50); }
        function showNextTerminalMessage() { const messageEl = document.getElementById('terminal-message'); if (!messageEl) return; const messageToShow = terminalMessages[currentMessageIndex]; typeMessage(messageEl, messageToShow); currentMessageIndex = (currentMessageIndex + 1) % terminalMessages.length; }

        // === SỬA ĐỔI: Tách logic render game ra một hàm riêng ===
        let allGames = []; // Biến để lưu trữ danh sách game gốc
        const gameContainer = document.getElementById('game-container');

        function renderGames(gamesToDisplay) {
            gameContainer.innerHTML = ''; // Xóa danh sách game hiện tại
            if (gamesToDisplay.length > 0) {
                gamesToDisplay.forEach(game => {
                    const card = document.createElement('div');
                    card.className = 'game-card-enhanced';
                    const colors = getColorScheme(game.winRate);
                    card.innerHTML = `<div class="game-card-inner-frame"><div class="card-image-wrapper"><img src="${game.image_url}" alt="${game.name}"></div></div><div class="game-card-content"><div class="game-info"><h4 class="game-name">${game.name}</h4></div><div class="status-tag-wrapper"><span class="status-tag ${colors.className}">${colors.tag}</span></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${game.winRate}%; background: ${colors.gradientColor};"></div></div><button class="action-button" style="background: ${colors.gradientColor};">${game.winRate}%</button></div>`;
                    card.onclick = () => {
                        const params = new URLSearchParams(window.location.search);
                        const lobbyName = decodeURIComponent(params.get('lobby_name'));
                        const url = `/analysis.html?gameName=${encodeURIComponent(game.name)}&imageUrl=${encodeURIComponent(game.image_url)}&winRate=${game.winRate}&lobbyName=${encodeURIComponent(lobbyName)}`;
                        window.location.href = url;
                    };
                    gameContainer.appendChild(card);
                });
            } else {
                gameContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #fff;">Không tìm thấy game nào phù hợp.</p>';
            }
        }
        
        window.onload = async () => {
            updateClock();
            setInterval(updateClock, 1000);
            showNextTerminalMessage();
            setInterval(showNextTerminalMessage, 10000);

            const params = new URLSearchParams(window.location.search);
            const lobbyId = params.get('lobby_id');
            const lobbyName = decodeURIComponent(params.get('lobby_name'));
            if (!lobbyId) { window.location.href = '/dashboard.html'; return; }

            document.getElementById('lobby-title').textContent = lobbyName;
            const response = await fetch(`/api/games-with-rates?lobby_id=${lobbyId}`);
            const data = await response.json();
            
            if (data.success) {
                allGames = data.games; // Lưu danh sách game gốc
                renderGames(allGames); // Hiển thị tất cả game ban đầu
            } else {
                gameContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #fff;">Sảnh này chưa có game nào.</p>';
            }

            // === THÊM MỚI: Gắn sự kiện cho ô tìm kiếm ===
            const searchInput = document.getElementById('game-search-input');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredGames = allGames.filter(game => game.name.toLowerCase().includes(searchTerm));
                renderGames(filteredGames);
            });
        };

        function getColorScheme(rate) { if (rate > 85) return { className: 'tag-jackpot', tag: 'JACKPOT', gradientColor: 'linear-gradient(45deg, #00ff8c, #00b894)' }; else if (rate > 60) return { className: 'tag-play', tag: 'CHƠI', gradientColor: 'linear-gradient(45deg, #ffc62b, #ff8e00)' }; else return { className: 'tag-wait', tag: 'CHỜ', gradientColor: 'linear-gradient(45deg, #d90429, #ef233c)' }; }
    </script>
</body>
</html>
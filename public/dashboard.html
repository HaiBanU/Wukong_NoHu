<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bảng Điều Khiển</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/user.css">
</head>
<body>
    <video autoplay muted loop id="background-video">
        <source src="/assets/videos/space-bg.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>
    <div class="shooting-stars"><span class="star"></span><span class="star"></span></div>

    <header class="header fadeIn">
        <div class="header-left">
            <a href="/brand-selection.html" class="back-button-user" style="position: static; transform: none; text-decoration: none; color: white;">← Chọn Lại</a>
        </div>
        <div class="header-center">
            <div id="welcome-message">Chào, ...!</div>
            <div id="live-clock-container"></div>
        </div>
        <div class="header-right">
            <div class="header-right-content">
                <div id="coin-display">Token: ...</div>
                <button class="logout-button">Đăng Xuất</button>
            </div>
        </div>
    </header>

    <main class="main-content fadeIn" style="animation-delay: 0.2s;">
        <h2 class="main-title" id="main-title-header">Đang tải...</h2>
        <div class="grid-container" id="lobby-container"></div>
    </main>
    
    <div class="terminal-notification fadeIn" style="animation-delay: 0.5s;">
        <div class="terminal-bot-icon"><img src="/assets/images/bot-icon.png" alt="Bot Icon"></div>
        <div class="terminal-content">
            <div class="terminal-header">Terminal</div>
            <div class="terminal-body"><span id="terminal-message"></span><span class="cursor"></span></div>
        </div>
    </div>

    <script>
        document.querySelector('.logout-button').addEventListener('click', () => { localStorage.clear(); window.location.href = '/'; });
        function updateClock() { const clockContainer = document.getElementById('live-clock-container'); if (!clockContainer) return; const now = new Date(); const timeString = now.toLocaleTimeString('vi-VN'); const dateString = now.toLocaleDateString('vi-VN'); clockContainer.innerHTML = `<span class="clock-time">${timeString}</span><span class="clock-date">${dateString}</span>`; }
        const terminalMessages = [ "Đang quét các sảnh...", "Phân tích dữ liệu thời gian thực.", "Hệ thống đã sẵn sàng." ];
        let currentMessageIndex = 0; let typingInterval;
        function typeMessage(element, message) { if (typingInterval) clearInterval(typingInterval); let i = 0; element.innerHTML = ''; typingInterval = setInterval(() => { if (i < message.length) { element.textContent += message.charAt(i); i++; } else { clearInterval(typingInterval); } }, 50); }
        function showNextTerminalMessage() { const messageEl = document.getElementById('terminal-message'); if (!messageEl) return; const messageToShow = terminalMessages[currentMessageIndex]; typeMessage(messageEl, messageToShow); currentMessageIndex = (currentMessageIndex + 1) % terminalMessages.length; }

        window.onload = async () => {
            updateClock();
            setInterval(updateClock, 1000);
            showNextTerminalMessage();
            setInterval(showNextTerminalMessage, 10000);

            const brandName = sessionStorage.getItem('selectedBrand');
            
            if (!brandName) {
                alert("Lỗi: Vui lòng chọn một trang game.");
                window.location.href = '/brand-selection.html';
                return;
            }
            
            document.getElementById('main-title-header').textContent = `SẢNH GAME CỦA ${brandName.toUpperCase()}`;

            const username = localStorage.getItem('username');
            if (!username) { window.location.href = '/'; return; }

            const [userRes, lobbyRes] = await Promise.all([
                fetch(`/api/user-info?username=${username}`),
                fetch('/api/lobbies')
            ]);
            const userData = await userRes.json();
            const lobbyData = await lobbyRes.json();

            if (userData.success) {
                document.getElementById('welcome-message').textContent = `Chào, ${userData.userInfo.username}!`;
                document.getElementById('coin-display').textContent = `Token: ${userData.userInfo.coins}`;
            }

            const lobbyContainer = document.getElementById('lobby-container');
            lobbyContainer.innerHTML = '';
            if (lobbyData.success && lobbyData.lobbies.length > 0) {
                lobbyData.lobbies.forEach(lobby => {
                    const card = document.createElement('a');
                    // === BẮT ĐẦU SỬA ĐỔI ===
                    // Thay thế lobby.id bằng lobby._id để lấy đúng ID từ MongoDB
                    card.href = `/games.html?lobby_id=${lobby._id}&lobby_name=${encodeURIComponent(lobby.name)}`;
                    // === KẾT THÚC SỬA ĐỔI ===
                    card.className = 'lobby-card';
                    card.innerHTML = `<div class="card-image-wrapper"><img src="${lobby.logo_url}" alt="${lobby.name}"></div><div class="card-title-bar"><p>${lobby.name}</p></div>`;
                    lobbyContainer.appendChild(card);
                });
            } else {
                lobbyContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #fff;">Admin chưa tạo sảnh game.</p>`
            }
        };
    </script>
</body>
</html>
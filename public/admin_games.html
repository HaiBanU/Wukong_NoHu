<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản Lý Game</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body class="admin-page">
    <header class="header fadeIn">
        <a href="/admin.html" class="back-button">&larr; Quay lại Menu</a>
        <div class="header-right-group">
            <div id="admin-coin-display">Token: ...</div>
            <button class="logout-button">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span>Đăng Xuất</span>
            </button>
        </div>
    </header>

    <main class="fadeIn" style="animation-delay: 0.2s;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin-top:0;">Quản Lý Sảnh Game</h2>
            <div>
                <button id="save-order-btn" class="btn-primary" style="display: none; width: auto; padding: 12px 20px; margin-right: 15px; background: #28a745;">Lưu Thứ Tự</button>
                <button class="btn-primary" style="width: auto; padding: 12px 20px;" onclick="openAddLobbyModal()">Tạo Sảnh Mới</button>
            </div>
        </div>
        <p id="message" style="text-align: right; height: 20px; margin-top: 10px;"></p>
        
        <div id="lobby-container" class="grid-container" style="margin-top: 20px; cursor: grab;">
        </div>
    </main>

    <div id="addLobbyModal" class="modal">
        <div class="modal-content fadeIn">
            <span class="close-btn" onclick="closeModals()">&times;</span>
            <h2>Tạo Sảnh Game Mới</h2>
            <form id="add-lobby-form">
                <div class="form-group">
                    <input type="text" name="name" placeholder="Tên Sảnh" required>
                </div>
                <div class="form-group">
                    <label>Logo Sảnh (Khuyến khích ảnh GIF)</label>
                    <input type="file" name="logo" accept="image/gif, image/jpeg, image/png" required>
                </div>
                <button type="submit" class="btn-primary">Tạo Sảnh</button>
            </form>
        </div>
    </div>
    
    <script>
        const lobbyContainer = document.getElementById('lobby-container');
        const addLobbyModal = document.getElementById('addLobbyModal');
        const addLobbyForm = document.getElementById('add-lobby-form');
        const saveOrderBtn = document.getElementById('save-order-btn');
        const messageEl = document.getElementById('message');
        let sortableInstance = null;

        function openAddLobbyModal() { addLobbyModal.style.display = 'flex'; }
        function closeModals() { addLobbyModal.style.display = 'none'; }
        
        function showMessage(msg, isSuccess) {
            messageEl.textContent = msg;
            messageEl.className = isSuccess ? 'success' : 'error';
            setTimeout(() => { messageEl.textContent = ''; }, 3000);
        }

        async function fetchAndDisplayLobbies() {
            const response = await fetch('/api/lobbies');
            const data = await response.json();
            lobbyContainer.innerHTML = '';
            if (data.success && data.lobbies.length > 0) {
                data.lobbies.forEach(lobby => {
                    const cardLink = document.createElement('a');
                    cardLink.href = `/admin_manage_lobby.html?id=${lobby._id}&name=${encodeURIComponent(lobby.name)}`;
                    cardLink.className = 'card';
                    cardLink.style.textDecoration = 'none'; 
                    cardLink.style.color = 'inherit';
                    cardLink.dataset.id = lobby._id;

                    cardLink.innerHTML = `
                        <h3>${lobby.name}</h3>
                        <img src="${lobby.logo_url}" style="width: 100px; height: 50px; object-fit: contain;">
                        <p style="margin-top: 10px; font-size: 0.8em; color: var(--admin-text-subtle);">Nhấn để quản lý game</p>
                    `;
                    lobbyContainer.appendChild(cardLink);
                });
                
                if (!sortableInstance) {
                    sortableInstance = new Sortable(lobbyContainer, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: function() {
                            saveOrderBtn.style.display = 'inline-block';
                        }
                    });
                }

            } else {
                 lobbyContainer.innerHTML = `<p style="text-align:center; color: var(--admin-text-subtle); grid-column: 1 / -1;">Chưa có sảnh nào. Hãy nhấn "Tạo Sảnh Mới".</p>`
            }
        }

        addLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(addLobbyForm);
            await fetch('/api/add-lobby', { method: 'POST', body: formData });
            addLobbyForm.reset();
            closeModals();
            fetchAndDisplayLobbies();
        });
        
        saveOrderBtn.addEventListener('click', async () => {
            if (!sortableInstance) return;
            const orderedIds = sortableInstance.toArray();
            saveOrderBtn.textContent = 'Đang lưu...';
            saveOrderBtn.disabled = true;

            const response = await fetch('/api/update-lobby-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderedIds })
            });
            const result = await response.json();
            showMessage(result.message, result.success);
            saveOrderBtn.textContent = 'Lưu Thứ Tự';
            saveOrderBtn.disabled = false;
            if (result.success) {
                saveOrderBtn.style.display = 'none';
            }
        });
        
        document.querySelector('.logout-button').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = '/';
        });
        
        async function fetchAdminInfo() {
            const username = localStorage.getItem('username');
            const coinDisplay = document.getElementById('admin-coin-display');
            if (localStorage.getItem('isSuperAdmin') === 'true' || !coinDisplay) {
                if(coinDisplay) coinDisplay.style.display = 'none';
                return;
            };

            const response = await fetch(`/api/user-info?username=${username}`);
            const data = await response.json();
            if (data.success) {
                coinDisplay.textContent = `Token còn lại: ${data.userInfo.coins}`;
            }
        }

        window.onclick = (event) => {
            if (event.target == addLobbyModal) {
                closeModals();
            }
        }
        
        window.onload = () => {
            fetchAndDisplayLobbies();
            fetchAdminInfo();
        };
    </script>
</body>
</html>
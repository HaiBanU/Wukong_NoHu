<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Wukong Slot</title> <!-- Đã sửa -->
    <link rel="icon" type="image/png" href="/assets/images/favicon.png"> <!-- Đã thêm -->
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/user.css"> 
    <link rel="stylesheet" href="/css/brand-selection-final.css">
</head>
<script>
    if (!localStorage.getItem('username')) {
        window.location.href = '/';
    }
</script>
<body class="brand-selection-page">
    <div id="page-background"></div>
    <div id="space-dust-overlay"></div>
    <div id="background-effects"></div>
    <div id="grid-overlay"></div>
    
    <div class="video-overlay"></div>
    <div class="shooting-stars">
        <span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span>
        <span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span>
        <span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span>
        <span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span><span class="star"></span>
    </div>

    <header class="header fadeIn">
        <div class="header-left"><div id="welcome-message">Chào, ...!</div></div>
        <div class="header-center"><div id="live-clock-container"></div></div>
        <div class="header-right">
             <div class="header-right-content">
                <div id="coin-display">Token: ...</div>
                <button class="logout-button">Đăng Xuất</button>
            </div>
        </div>
    </header>

    <main class="carousel-main-content fadeIn" style="animation-delay: 0.2s;">
        <h2 class="main-title">CHỌN SẢNH GAME</h2>
        <div class="carousel-container">
            <div class="brand-slider" id="brand-slider">
            </div>
        </div>
        <div class="carousel-controls">
            <button id="prev-btn" class="control-btn"><span class="arrow">&#9664;</span> BACK</button>
            <button id="next-btn" class="control-btn">NEXT <span class="arrow">&#9654;</span></button>
        </div>
    </main>

    <div class="terminal-notification fadeIn" style="animation-delay: 0.5s;">
        <div class="terminal-bot-icon"><img src="/assets/images/bot-icon.png" alt="Bot Icon"></div>
        <div class="terminal-content">
            <div class="terminal-header">Terminal</div>
            <div class="terminal-body"><span id="terminal-message"></span><span class="cursor"></span></div>
        </div>
    </div>

    <script>
        document.querySelector('.logout-button').addEventListener('click', () => { localStorage.clear(); window.location.href = '/'; });
        function updateClock() { const clockContainer = document.getElementById('live-clock-container'); if (!clockContainer) return; const now = new Date(); const timeString = now.toLocaleTimeString('vi-VN'); const dateString = now.toLocaleDateString('vi-VN'); clockContainer.innerHTML = `<span class="clock-time">${timeString}</span><span class="clock-date">${dateString}</span>`; }
        
        const gameBrands = [ { name: 'AU88', logo: 'au88.png' }, { name: 'MB66', logo: 'mb66.png' }, { name: 'MM88', logo: 'mm88.png' }, { name: 'RR88', logo: 'rr88.png' }, { name: 'XX88', logo: 'xx88.png' }, { name: 'QH88', logo: 'qh88.png' }, { name: 'F8BET', logo: 'f8bet.png' }, { name: 'SHBET', logo: 'shbet.png' }, { name: '188BET', logo: '188bet.png' }, { name: 'FLY88', logo: 'fly88.png' }, { name: 'QQ88', logo: 'qq88.png' }, { name: 'U888', logo: 'u888.png' }, { name: 'BL555', logo: 'bl555.png' } ];

        window.onload = async () => {
            updateClock();
            setInterval(updateClock, 1000);
            
            const terminalMessages = [ 
                "Khởi tạo Giao thức Wukong... Hoàn tất.",
                "Xác thực danh tính Chỉ Huy... Thành công.",
                "Đang tải danh sách các SẢNH GAME đối tác...",
                "Tất cả module phân tích đã được nạp.",
                "Kết nối an toàn tới máy chủ trung tâm đã được thiết lập.",
                "Hiệu suất hệ thống: 100%. Sẵn sàng nhận lệnh.",
                "Vui lòng chọn một mục tiêu để bắt đầu đồng bộ hóa dữ liệu.",
                "Dữ liệu là chìa khóa. Hãy chọn đúng cánh cửa."
            ];
            let lastMessageIndex = -1;
            let typingInterval;
            function typeMessage(element, message) { if (typingInterval) clearInterval(typingInterval); let i = 0; element.innerHTML = ''; typingInterval = setInterval(() => { if (i < message.length) { element.textContent += message.charAt(i); i++; } else { clearInterval(typingInterval); } }, 50); }
            function showNextTerminalMessage() { 
                const messageEl = document.getElementById('terminal-message'); 
                if (!messageEl) return;
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * terminalMessages.length);
                } while (randomIndex === lastMessageIndex && terminalMessages.length > 1);
                lastMessageIndex = randomIndex;
                const messageToShow = terminalMessages[randomIndex]; 
                typeMessage(messageEl, messageToShow); 
            }
            showNextTerminalMessage();
            setInterval(showNextTerminalMessage, 8000);

            const username = localStorage.getItem('username');
            if (!username) { window.location.href = '/'; return; }

            try {
                // Sử dụng Promise.all để gọi cả 2 API cùng lúc cho nhanh hơn
                const [userRes, priorityRes] = await Promise.all([
                    fetch(`/api/user-info?username=${username}`),
                    fetch(`/api/user-brand-priority?username=${username}`) // Gọi API mới
                ]);

                const userData = await userRes.json();
                const priorityData = await priorityRes.json();

                if (userData.success) {
                    document.getElementById('welcome-message').textContent = `Chào, ${userData.userInfo.username}!`;
                    document.getElementById('coin-display').textContent = `Token: ${userData.userInfo.coins}`;
                }
                
                // Lấy danh sách sảnh ưu tiên từ API
                const priorityBrands = priorityData.success ? priorityData.priorityBrands : [];
                
                // Logic sắp xếp lại mảng gameBrands
                let sortedGameBrands = [...gameBrands]; // Tạo một bản sao để sắp xếp
                if (priorityBrands.length > 0) {
                    // Lọc ra các sảnh ưu tiên và các sảnh còn lại
                    const priorityBrandObjects = [];
                    const otherBrands = [];

                    gameBrands.forEach(brand => {
                        const priorityIndex = priorityBrands.indexOf(brand.name);
                        if (priorityIndex !== -1) {
                            // Nếu là sảnh ưu tiên, lưu lại cùng với vị trí của nó
                            priorityBrandObjects[priorityIndex] = brand;
                        } else {
                            otherBrands.push(brand);
                        }
                    });
                    
                    // Ghép mảng ưu tiên (đã được sắp xếp) với mảng còn lại
                    sortedGameBrands = [...priorityBrandObjects.filter(b => b), ...otherBrands];
                }
                
                const slider = document.getElementById('brand-slider');
                const prevBtn = document.getElementById('prev-btn');
                const nextBtn = document.getElementById('next-btn');
                
                // Sử dụng mảng ĐÃ SẮP XẾP để tạo HTML
                slider.innerHTML = sortedGameBrands.map(brand => `
                    <div class="brand-card" data-brand-name="${brand.name}">
                        <div class="brand-card-inner">
                             <div class="logo-background">
                                <img class="brand-logo" src="/assets/logos/${brand.logo}" alt="${brand.name}">
                            </div>
                            <div class="brand-name">${brand.name}</div>
                        </div>
                    </div>`
                ).join('');

                const cards = document.querySelectorAll('.brand-card');
                
                // <<< BẮT ĐẦU CẬP NHẬT LOGIC JS CHO 5 THẺ >>>
                let activeIndex = 0;

                function updateCarousel() {
                    cards.forEach((card, i) => {
                        // Xóa tất cả các lớp vị trí cũ
                        card.classList.remove('active', 'prev', 'next', 'prev2', 'next2');

                        // Tính toán chỉ số cho cả 5 vị trí
                        const prev2Index = (activeIndex - 2 + cards.length) % cards.length;
                        const prevIndex = (activeIndex - 1 + cards.length) % cards.length;
                        const nextIndex = (activeIndex + 1) % cards.length;
                        const next2Index = (activeIndex + 2) % cards.length;
                        
                        // Gán lớp mới dựa trên vị trí
                        if (i === activeIndex) {
                            card.classList.add('active');
                        } else if (i === prevIndex) {
                            card.classList.add('prev');
                        } else if (i === nextIndex) {
                            card.classList.add('next');
                        } else if (i === prev2Index) {
                            card.classList.add('prev2');
                        } else if (i === next2Index) {
                            card.classList.add('next2');
                        }
                    });
                }

                nextBtn.addEventListener('click', () => { activeIndex = (activeIndex + 1) % cards.length; updateCarousel(); });
                prevBtn.addEventListener('click', () => { activeIndex = (activeIndex - 1 + cards.length) % cards.length; updateCarousel(); });
                
                slider.addEventListener('click', (e) => {
                    const clickedCard = e.target.closest('.brand-card');
                    if (!clickedCard) return;

                    if (clickedCard.classList.contains('active')) {
                        const brandName = clickedCard.dataset.brandName;
                        sessionStorage.setItem('selectedBrand', brandName);
                        window.location.href = `/dashboard.html`;
                    } 
                    // Nếu nhấn vào bất kỳ thẻ nào bên phải, di chuyển sang phải 1 bước
                    else if (clickedCard.classList.contains('next') || clickedCard.classList.contains('next2')) { 
                        activeIndex = (activeIndex + 1) % cards.length; 
                        updateCarousel(); 
                    }
                    // Nếu nhấn vào bất kỳ thẻ nào bên trái, di chuyển sang trái 1 bước
                    else if (clickedCard.classList.contains('prev') || clickedCard.classList.contains('prev2')) { 
                        activeIndex = (activeIndex - 1 + cards.length) % cards.length; 
                        updateCarousel(); 
                    }
                });

                updateCarousel();
                // <<< KẾT THÚC CẬP NHẬT LOGIC JS CHO 5 THẺ >>>

            } catch (e) {
                console.error("Lỗi khi tải dữ liệu trang chọn sảnh:", e);
            }
        };
    </script>
    
    <script>
        const overlay = document.querySelector('.video-overlay');
        if (overlay) {
            window.addEventListener('mousemove', (e) => {
                const { clientX, clientY } = e;
                overlay.style.setProperty('--mouse-x', `${clientX}px`);
                overlay.style.setProperty('--mouse-y', `${clientY}px`);
            });
        }
    </script>
</body>
</html>